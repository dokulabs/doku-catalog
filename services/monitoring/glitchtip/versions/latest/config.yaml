version: latest
description: GlitchTip - Open-source Sentry-compatible error tracking

# Multi-container service configuration
# GlitchTip requires a web service and a celery worker

# Init container for database migrations
init_containers:
  - name: migrate
    image: glitchtip/glitchtip:latest
    command:
      - "./manage.py"
      - "migrate"
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/glitchtip
      SECRET_KEY: change-me-to-a-random-secret-key
    depends_on: []

containers:
  # Web service - serves the UI and API
  - name: web
    image: glitchtip/glitchtip:latest
    primary: true
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/glitchtip
      SECRET_KEY: change-me-to-a-random-secret-key
      PORT: "8000"
      GLITCHTIP_DOMAIN: https://glitchtip.doku.local
      DEFAULT_FROM_EMAIL: glitchtip@doku.local
      EMAIL_URL: smtp://mailpit:1025
      CELERY_WORKER_AUTOSCALE: "1,3"
      CELERY_WORKER_CONCURRENCY: "2"
      ENABLE_USER_REGISTRATION: "true"
      ENABLE_ORGANIZATION_CREATION: "true"
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - worker
    volumes:
      - /var/lib/glitchtip/uploads
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/_health/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start: 60s
    resources:
      memory_min: 256m
      memory_max: 1g
      cpu_min: "0.25"
      cpu_max: "1.0"

  # Celery worker - processes background tasks
  - name: worker
    image: glitchtip/glitchtip:latest
    primary: false
    command:
      - "./bin/run-celery-with-beat.sh"
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/glitchtip
      SECRET_KEY: change-me-to-a-random-secret-key
      CELERY_WORKER_AUTOSCALE: "1,3"
      CELERY_WORKER_CONCURRENCY: "2"
      REDIS_URL: redis://redis:6379/0
    depends_on: []
    volumes:
      - /var/lib/glitchtip/uploads
    resources:
      memory_min: 256m
      memory_max: 1g
      cpu_min: "0.25"
      cpu_max: "1.0"

# Service-level settings
port: 8000
protocol: http

# No automatic dependencies - user installs these separately
# This allows reusing existing postgres/redis instances

# Overall resource requirements
resources:
  memory_min: 512m
  memory_max: 2g
  cpu_min: "0.5"
  cpu_max: "2.0"

# Default environment variables
# Users can override with --env flags
environment:
  SECRET_KEY: change-me-to-a-random-secret-key
  DATABASE_URL: postgres://postgres:postgres@postgres:5432/glitchtip
  REDIS_URL: redis://redis:6379/0
  EMAIL_URL: smtp://mailpit:1025
  DEFAULT_FROM_EMAIL: glitchtip@doku.local

# Post-install instructions shown to user
post_install: |
  ╔═══════════════════════════════════════════════════════════════════════╗
  ║                    GlitchTip Setup Instructions                       ║
  ╚═══════════════════════════════════════════════════════════════════════╝

  GlitchTip requires PostgreSQL, Redis, and optionally a mail server.

  PREREQUISITES (install if not already running):
    doku install postgres:16 --name postgres --env POSTGRES_DB=glitchtip
    doku install redis:7.4 --name redis
    doku install mailpit --name mailpit    # For email testing

  ACCESS:
    - GlitchTip UI: https://glitchtip.doku.local
    - Mailpit UI:   https://mailpit.doku.local (view verification emails)

  SENTRY SDK USAGE:
    After creating a project in GlitchTip, use the DSN in your app:

    import sentry_sdk
    sentry_sdk.init(dsn="https://<key>@glitchtip.doku.local/<project_id>")

  CUSTOM CONFIGURATION:
    Override defaults with --env flags:
    doku install glitchtip --env SECRET_KEY=$(openssl rand -hex 32)
